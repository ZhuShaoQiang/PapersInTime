<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>论文</title>
</head>
<body id="htmlbody">
    <div class=".container col-8 justify-content-center offset-2">
        <!-- 导航栏-->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
                <a class="navbar-brand" href="/">阅读论文关联系统</a>
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="/static/papers/management.html">论文管理<span class="sr-only"></span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">时间轴查看<span class="sr-only"></span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">引用树查看<span class="sr-only"></span></a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- 上传论文的表单 -->
    <form id="paperToBeUploadForm" enctype="multipart/form-data">
        <div class="form-row">
            <!-- 可以同行多个 -->
            <div class="form-group col-4">
                <label for="citename">引用名字</label>
                <input id="citename" name="citename" class="form-control" type="text" placeholder="这个论文被引用的名字" required>
            </div>
            <div class="form-group col-4">
                <label for="papertile">论文题目</label>
                <input id="papertitle" name="papertitle" class="form-control" type="text" placeholder="上传的论文题目" required>
            </div>
            <div class="form-group col-4">
                <label for="authorname">作者名字</label>
                <input id="authorname" name="authorname" class="form-control" type="text" placeholder="作者姓名" required>
            </div>
            <div class="form-group col-3">
                <label for="pubyear">发表年份</label>
                <input id="pubyear" name="pubyear" class="form-control" type="text" placeholder="发表的年份" required>
            </div>
            <div class="form-group col-9">
                <label for="labels">标签</label>
                <input id="labels" name="paperlabel" class="form-control" type="text" placeholder="论文涉及的标签">
            </div>
        </div>
        <div class="form-group row">
            <!-- 文字和输入在同一行 -->
            <label for="cites" class="col-sm-3 col-form-label">引用的论文</label>
            <div class="col-sm-9">
                <input id="cites" name="cites" class="form-control" type="text" placeholder="引用的其他论文">
            </div>
        </div>
        <div class="form-group row">
            <label for="cited" class="col-sm-3 col-form-label">被这些论文引用</label>
            <div class="col-sm-9">
                <input id="cited" name="cited" class="form-control" type="text" placeholder="被哪些论文引用了">
            </div>
        </div>

        <div class="form-group row">
            <div class="custom-file">
                <input type="file" accept=".pdf" name="file" class="custom-file-input" id="papertosubmit">
                <label class="custom-file-label" for="papertosubmit">选择需要上传的论文（可拖动文件放入）</label>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">上传论文信息</button>
    </form>

    <hr>    

    <h2>现有论文</h2>
    <!-- 展示已经上传的论文 -->
     <div class=".container row" id="containerForCards">
        暂时无论文检索到....
     </div>

    </div>

    <!-- 下面是一个大幕，用来展示论文详情的 -->
    <div class="modal" style="height: 99%; width: 99%;" tabindex="-1" id="paperDetailModal">
        <div class="modal-dialog modal-xl modal-dialog-scrollable" style="height: 100%; width: 100%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal_title"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick='CloseModalWithID("paperDetailModal")'>
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body modal-xl">
                    <iframe id="iframeInPaperDetailModal" frameborder="0" width="100%", height="100%">
                    </iframe>
                </div>
                <div class="modal-footer">
                    <input type="text" id="paperCiteNameCur" hidden readonly="true" />
                    <button type="button" class="btn btn-primary" onclick="JumpToCiteTreeInModal()">跳转至引用树查看</button>
                </div>
            </div>
        </div>
    </div>


    <!-- 使用bootstrap和jquery -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jquery -->
     <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

    <style>
        #dropzone {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 20px;
            width: 300px;
            margin: 20px auto;
            text-align: center;
        }
    </style>

    <!-- 自己的代码 -->
    <script src="/static/js/pagesOp/addButtonWithCallback.js"></script>
    <script src="/static/js/actions/buttonActions.js"></script>
    <script>
        $(document).ready(function() {
            // 获取现有的论文并加载到页面上
            function loadPapers() {
                $.ajax({
                    url: '/getpapers',
                    method: 'GET',
                    success: function(data) {
                        if (data.length == 0) {
                            console.log("没有论文");
                            return;
                        }
                        const cardsObject = $("#containerForCards");  // 拿到需要放置到的位置
                        cardsObject.html("");  // 清空现有表格

                        data.forEach(paper => {
                            // 创建内部container，专门放置button
                            var divForButton = $(`<div>`);
                            divForButton.addClass(".container");
                            divForButton.addClass("row");
                            CreateButtonAppendToDivWithCallback("detail_"+paper.citeName, "btn btn-primary", "查看详情", divForButton, DetailCallback);
                            CreateButtonAppendToDivWithCallback("download_"+paper.citeName, "btn btn-info", "下载论文", divForButton, DownloadCallback);
                            CreateButtonAppendToDivWithCallback("delete_"+paper.citeName, "btn btn-danger", "删除论文", divForButton, DeleteCallback);

                            // 创建card-body并添加按钮
                            var cardBody = $(`
                            <div class="card-body">
                                <h5 class="card-title">${paper.author}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">${paper.year}</h6>
                                <p class="card-text">${paper.title}</p>
                            </div>
                            `)
                            divForButton.appendTo(cardBody)

                            // 创建一个card，添加body并且添加到页面
                            $(`
                                <div class="card" style="width: 18rem;" id="${paper.citeName}">
                                </div>
                            `).append(cardBody).appendTo(cardsObject)
                            
                        });
                    },
                    error: function() {
                        alert('加载论文列表失败');
                    }
                });
            }

            // 上传新论文
            $('#paperToBeUploadForm').on('submit', function(e) {
                e.preventDefault();  // 阻止默认的行为，只执行自己的

                var formData = new FormData(this);
                console.log("formdata: ", formData);

                $.ajax({
                    url: "/upload",  // 向/uploadurl上传
                    method: "post",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        loadPapers();  // 重新加载现有论文
                    },
                    error: function(jqXHR, textStatus, errThrown){
                        console.log("error");
                    }
                });

            });

            // 页面加载时获取现有论文
            loadPapers();
        });
    </script>
</body>
</html>
